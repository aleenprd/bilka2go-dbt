WITH 
SOURCE AS (
  SELECT *
  FROM {{ ref('stg_snapshot__baby_and_children') }}
)
,CLEANED AS (
  SELECT
    PRODUCT_ID,
    CATEGORY_DK,
    CATEGORY_EN,
    TITLE,
    CAST(
      REPLACE(
        REPLACE(
          REPLACE(PRICE, '.', ''),
          ',-', ''),
        ',', '.')
    AS FLOAT64) AS PRICE,
    CONCAT('https://www.bilkatogo.dk', PRODUCT_URL) AS PRODUCT_URL,
    IMAGE_URL,
    CASE  
      WHEN REGEXP_CONTAINS(LOWER(PRODUCER), r'\s+g$')  THEN NULL
      WHEN REGEXP_CONTAINS(LOWER(PRODUCER), r'\s+stk$') THEN NULL
      WHEN REGEXP_CONTAINS(LOWER(PRODUCER), r'\s+l$') THEN NULL
      WHEN REGEXP_CONTAINS(LOWER(PRODUCER), r'\s+kg$') THEN NULL
      WHEN REGEXP_CONTAINS(LOWER(PRODUCER), r'\s+ml$') THEN NULL
      ELSE PRODUCER 
    END AS PRODUCER,
    REPLACE(
      LOWER(
        SPLIT(PRICE_PER_UNIT, '/')[OFFSET(1)]), '.', '') 
    AS MEASURE_UNIT,
    QUANTITY AS QUANTITY_RAW,
    CAST(SPLIT(QUANTITY, ' ')[OFFSET(0)] AS INT64) AS QUANTITY,
    CAST(
      REPLACE(
        REPLACE(SPLIT(PRICE_PER_UNIT, '/')[OFFSET(0)], '.', ''),
        ',', '.')
    AS FLOAT64) AS PRICE_PER_UNIT,
    LABEL1,
    LABEL2,
    LABEL3,
    DBT_SCD_ID,
    DBT_UPDATED_AT,
    DBT_VALID_FROM,
    DBT_VALID_TO
  FROM SOURCE
)
,FINAL AS (
  SELECT
    PRODUCT_ID,
    CATEGORY_DK,
    CATEGORY_EN,
    TITLE,
    PRODUCT_URL,
    IMAGE_URL,
    PRODUCER AS BRAND,
    LABEL1,
    LABEL2,
    LABEL3,
    COALESCE(PRICE, PRICE_PER_UNIT) AS PRICE,
    CASE 
      WHEN MEASURE_UNIT = 'stk' THEN 'stk'
      WHEN MEASURE_UNIT = 'kg' THEN 'kg'
      WHEN MEASURE_UNIT = 'g' THEN 'kg'
      WHEN MEASURE_UNIT = 'l' THEN 'l'
      WHEN MEASURE_UNIT = 'ml' THEN 'l'
      WHEN MEASURE_UNIT = 'm' THEN 'm'
      WHEN MEASURE_UNIT = 'meter' THEN 'm'
      WHEN MEASURE_UNIT = 'centimeter' THEN 'm'
      WHEN MEASURE_UNIT = 'cm' then 'm'
      ELSE NULL
    END AS MEASURE_UNIT,
    CASE 
      WHEN LOWER(SPLIT(QUANTITY_RAW, ' ')[OFFSET(1)]) = 'g' 
        THEN QUANTITY / 1000
      WHEN LOWER(SPLIT(QUANTITY_RAW, ' ')[OFFSET(1)]) = 'ml' 
        THEN QUANTITY / 1000
      WHEN LOWER(SPLIT(QUANTITY_RAW, ' ')[OFFSET(1)]) = 'cm' 
        THEN QUANTITY / 100
      ELSE QUANTITY
    END AS QUANTITY,
    PRICE_PER_UNIT,
    DBT_SCD_ID,
    DBT_UPDATED_AT,
    DBT_VALID_FROM,
    DBT_VALID_TO
  FROM CLEANED
)
SELECT * FROM FINAL
